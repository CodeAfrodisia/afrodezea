import{c as W,e as B,r as n,o as T,j as s,L as U}from"./index-Cfo4WONF.js";import Q from"./NotesRadar-CQK1XroP.js";import{p as z}from"./profileHeuristics-B2N-M0O0.js";import{p as G,g as J,a as V}from"./ProductsGrid-BKAsmNLG.js";import{f as K,b as X}from"./ratings-Bx631r91.js";import"./productsSupabase-fJvJppfC.js";function Y(l=0,h="USD"){try{return new Intl.NumberFormat(void 0,{style:"currency",currency:h}).format(Number(l))}catch{return`$${Number(l).toFixed(2)}`}}function ne({open:l,onClose:h,product:A}){const{add:D}=W(),{user:M}=B(),c=A||null,x=(c?.handle||c?.slug||"").toLowerCase(),[I,v]=n.useState(c),[o,E]=n.useState(null),[S,N]=n.useState(null);n.useEffect(()=>{if(!l)return;const t=document.body.style.overflow;return document.body.style.overflow="hidden",()=>{document.body.style.overflow=t}},[l]),n.useEffect(()=>{l&&G()},[l]),n.useEffect(()=>{if(!l)return;if(!x){v(c);return}if(!(!c?.variants?.nodes?.length||!c?.description||!c?.image_url)){v(c);return}const r=J(x);r&&v(i=>i?.id===r.id?r:{...r,...i}),(async()=>{const i=await V(x);v(i?a=>a?.id===i.id?i:{...i,...a}:a=>a||c)})()},[l,x,c]);const e=I||c;n.useEffect(()=>{!l||!e?.id||(async()=>{try{const t=await K(e.id);E(t||null)}catch{E(null)}if(M?.id)try{const t=await X(e.id);N(t||null)}catch{N(null)}else N(null)})()},[l,e?.id,M?.id]);const C=n.useMemo(()=>{if(!e)return[];const t=[];return e.image_url&&t.push({url:e.image_url}),e.images?.nodes?.length&&t.push(...e.images.nodes),t.length?t:[{url:""}]},[e]),[F,P]=n.useState(0);n.useEffect(()=>P(0),[e?.id]);const R=e?.options||[],u=e?.variants?.nodes||[],[p,_]=n.useState({});n.useEffect(()=>{if(!u.length){_({});return}const t=u.find(i=>i.availableForSale)||u[0],r={};(t.selectedOptions||[]).forEach(i=>{r[i.name]=i.value}),_(r)},[e?.id,u.length]);const b=t=>String(t??"").toLowerCase().replace(/&/g,"and").replace(/[^a-z0-9]+/g,""),m=n.useMemo(()=>{if(!u.length)return null;const t=u.find(i=>(i.selectedOptions||[]).every(g=>b(p[g.name])===b(g.value)));if(t)return t;const r=Object.keys(p);if(r.length){const i=u.find(a=>{const g=Object.fromEntries((a.selectedOptions||[]).map(y=>[y.name,y.value]));return r.every(y=>b(p[y])===b(g[y]))});if(i)return i}return u[0]||null},[u,p]),$=n.useMemo(()=>m?.price?.amount!=null?Number(m.price.amount):e?.priceRange?.minVariantPrice?.amount!=null?Number(e.priceRange.minVariantPrice.amount):e?.price_cents!=null?e.price_cents/100:0,[m,e]),j=u.length&&m?m.availableForSale!==!1:!0,d=n.useMemo(()=>{if(e?.profile)return{Floral:e.profile.floral??0,Fruity:e.profile.fruity??0,Woody:e.profile.woody??0,Fresh:e.profile.fresh??0,Spicy:e.profile.spice??0,Strength:e.profile.strength??0,Citrus:e.profile.citrus??0,Sweet:e.profile.sweet??0,Smoky:e.profile.smoky??0};const t=(e?.description||"").replace(/<[^>]+>/g," "),r=z(t);return{Floral:r.floral,Fruity:r.fruity,Woody:r.woody,Fresh:r.fresh,Spicy:r.spice,Strength:r.strength??0,Citrus:r.citrus??0,Sweet:r.sweet??0,Smoky:r.smoky??0}},[e]),O=n.useMemo(()=>({floral:d.Floral??0,fruity:d.Fruity??0,citrus:d.Citrus??0,fresh:d.Fresh??0,woody:d.Woody??0,spicy:d.Spicy??0,sweet:d.Sweet??0,smoky:d.Smoky??0}),[d]),f=n.useMemo(()=>o?{floral:o.floral_avg??0,fruity:o.fruity_avg??0,citrus:o.citrus_avg??0,fresh:o.fresh_avg??0,woody:o.woody_avg??0,spicy:o.spicy_avg??0,sweet:o.sweet_avg??0,smoky:o.smoky_avg??0,strength:o.strength_avg??0,count:o.count_verified??0}:null,[o]),L=n.useMemo(()=>{if(!f)return null;if(!S)return f;const t=f.count||0,r=["floral","fruity","citrus","fresh","woody","spicy","sweet","smoky","strength"],i={};for(const a of r){const g=Number(f[a]??0),y=Number(S[a]??0);i[a]=Math.round((g*t+y)/(t+1))}return i},[f,S]),q=n.useMemo(()=>L||f||O,[L,f,O]),w=C[F]?.url||"",k=(e?.handle||e?.slug||"").toLowerCase(),H=k?`/product/${k}?fromQuick=1`:"/products";return l&&e?T.createPortal(s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"modalOverlay",onClick:h}),s.jsx("div",{className:"modal",role:"dialog","aria-modal":"true","aria-label":`${e.title} quick view`,children:s.jsxs("div",{className:"modalInner",children:[s.jsxs("div",{className:"glass-header",children:[s.jsxs("div",{style:{display:"grid"},children:[s.jsx("div",{className:"modalTitle",children:e.title}),e.collection&&s.jsx("small",{style:{opacity:.7},children:e.collection})]}),s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12},children:[s.jsx("strong",{className:"modalPrice",children:Y($,"USD")}),s.jsx("button",{className:"btn btn--icon",onClick:h,"aria-label":"Close",children:"✕"})]})]}),s.jsxs("div",{className:"modalBody",children:[s.jsxs("div",{children:[s.jsx("div",{className:"qv-hero",children:w?s.jsx("img",{src:w,alt:e.title,style:{width:"100%",height:"100%",objectFit:"cover",display:"block"}}):null}),C.length>1&&s.jsx("div",{className:"qv-thumbs",children:C.map((t,r)=>s.jsx("button",{className:`qv-thumb ${r===F?"active":""}`,onClick:()=>P(r),"aria-pressed":r===F,children:t.url?s.jsx("img",{src:t.url,alt:"",style:{width:"100%",height:"100%",objectFit:"cover"}}):null},r))})]}),s.jsxs("div",{className:"modalInfo",children:[s.jsx("p",{style:{margin:0,opacity:.9},children:e.description||"—"}),R?.length?s.jsx("div",{style:{display:"grid",gap:10,margin:"12px 0"},children:R.map(t=>s.jsxs("div",{children:[s.jsx("div",{style:{opacity:.8,marginBottom:6},children:t.name}),s.jsx("div",{style:{display:"flex",gap:8,flexWrap:"wrap"},children:(t.values||[]).map(r=>{const i=p[t.name]===r;return s.jsx("button",{type:"button",className:`chip ${i?"active":""}`,style:{padding:"6px 10px",borderRadius:999,border:"1px solid var(--hairline)",background:i?"rgba(212,175,55,.12)":"transparent"},onClick:()=>_(a=>({...a,[t.name]:r})),"aria-pressed":i,children:r},r)})})]},t.name))}):null,s.jsx(Q,{compact:!0,profile:q,chartScale:.65}),s.jsxs("div",{style:{display:"flex",gap:10,flexWrap:"wrap"},children:[s.jsx("button",{className:"btn btn--gold",disabled:!j,"aria-disabled":!j,title:j?void 0:"This variant is currently unavailable",onClick:()=>D({productId:e.id,title:e.title,variantId:m?.id?`${e.id}:${m.id}`:`${e.id}:default`,variantTitle:m?.title||"Default",image:w?{url:w}:null,price:{amount:$,currencyCode:"USD"},qty:1,selectedOptions:p}),children:j?"Add to Cart":"Unavailable"}),s.jsx(U,{to:H,className:"btn btn--ghost",onMouseEnter:()=>k&&V(k),onClick:h,children:"View details"}),s.jsx("button",{className:"btn btn--ghost",onClick:h,children:"Continue browsing"})]})]})]})]})})]}),document.body):null}export{ne as default};
