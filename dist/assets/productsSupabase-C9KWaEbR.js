import{s}from"./index-Du-y3j9l.js";const y=t=>(t??0)/100;function b(t){const a=Array.isArray(t.variants)?t.variants:[],n=a.length?a.map(i=>i.price_cents||0):[t.price_cents||0],r=Math.min(...n),l=Math.max(...n);return{id:t.id,title:t.title,handle:t.slug??t.handle??null,description:t.description||"",collection:t.collection||"",images:{nodes:t.image_url?[{url:t.image_url}]:[]},priceRange:{minVariantPrice:{amount:y(r),currencyCode:"USD"},maxVariantPrice:{amount:y(l),currencyCode:"USD"}},variants:{nodes:(a||[]).map(i=>({id:i.id??`${t.id}:${i.title??"default"}`,title:i.title??"Default",availableForSale:!!i.availableForSale,price:{amount:y(i.price_cents),currencyCode:"USD"},selectedOptions:i.selectedOptions||[]}))},options:Array.isArray(t.options)?t.options:[],collections:{nodes:t.collection?[{title:t.collection,handle:(t.collection||"").toLowerCase()}]:[]},tags:Array.isArray(t.tags)?t.tags:[],image_url:t.image_url||null,price_cents:t.price_cents??null}}async function $(t){let{data:a,error:n}=await s.from("products").select("*").eq("slug",t).maybeSingle();if(n?.code==="42703"||!a&&!n){const r=await s.from("products").select("*").eq("handle",t).maybeSingle();a=r.data,n=r.error}if(n)throw n;return a?b(a):null}async function D({q:t,collection:a,tags:n,minPriceCents:r,maxPriceCents:l,order:i="new",page:f=1,pageSize:o=24}={}){const _=Math.max(0,(f-1)*o),x=_+o-1;let e=s.from("products").select("*",{count:"exact"});if(t&&t.trim()){const m=t.trim(),p=async()=>await s.from("products").select("*",{count:"exact"}).textSearch("ft",m,{type:"plain"}),g=async()=>{const d=`%${m}%`;return await s.from("products").select("*",{count:"exact"}).or(`title.ilike.${d},description.ilike.${d}`)};let u,c;try{({data:u,error:c}=await p()),c?.code==="42703"&&({data:u,error:c}=await g())}catch{({data:u,error:c}=await g())}if(c)throw c;const A=(u||[]).map(d=>d.id);if(A.length===0)return{rows:[],total:0,page:f,pageSize:o};e=s.from("products").select("*",{count:"exact"}).in("id",A)}if(a&&a!=="all"){const p={affirmation:"Affirmation",afrodisia:"Afrodisia",pantheon:"Pantheon",fall:"Fall",winter:"Winter"}[a]??a;e=e.eq("collection",p)}n&&n.length&&(e=e.overlaps("tags",n)),typeof r=="number"&&(e=e.gte("price_cents",r)),typeof l=="number"&&(e=e.lte("price_cents",l)),i==="price_asc"?e=e.order("price_cents",{ascending:!0,nullsFirst:!0}):i==="price_desc"?e=e.order("price_cents",{ascending:!1,nullsLast:!0}):e=e.order("created_at",{ascending:!1,nullsLast:!0});const L=e.range(_,x),{data:S,error:h,count:B}=await L;if(h)throw h;return{rows:(S||[]).map(b),total:B||0,page:f,pageSize:o}}export{$ as f,D as s};
