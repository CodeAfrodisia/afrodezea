import{r as n,o as D,j as i}from"./index-Cfo4WONF.js";import{b as L,s as z}from"./ratings-Bx631r91.js";function r(a){const l=Number(a??0);return Number.isNaN(l)?0:Math.max(0,Math.min(5,l))}const F=["floral","fruity","citrus","woody","fresh","spicy","sweet","smoky","strength"];function U({open:a,onClose:l,product:c,existingRating:y=null,rateToken:K=null,onSubmitted:j=null,userId:k=null}){const[s,g]=n.useState({floral:0,fruity:0,citrus:0,woody:0,fresh:0,spicy:0,sweet:0,smoky:0,strength:3}),[E,S]=n.useState(null),[N,m]=n.useState(!1),[f,h]=n.useState(!1),[p,d]=n.useState(""),b=n.useRef(null),x=n.useRef(null);if(n.useEffect(()=>{if(!a)return;const e=document.body.style.overflow;return document.body.style.overflow="hidden",()=>{document.body.style.overflow=e}},[a]),n.useEffect(()=>{let e=!0;if(!(!a||!c?.id))return d(""),m(!0),(async()=>{try{const t=await L(c.id)||y||null;if(!e)return;S(t),g({floral:r(t?.floral??0),fruity:r(t?.fruity??0),citrus:r(t?.citrus??0),woody:r(t?.woody??0),fresh:r(t?.fresh??0),spicy:r(t?.spicy??0),sweet:r(t?.sweet??0),smoky:r(t?.smoky??0),strength:r(t?.strength??3)}),setTimeout(()=>x.current?.focus(),0)}catch(t){if(!e)return;console.error(t),d(t?.message||"Could not load your previous rating.")}finally{e&&m(!1)}})(),()=>{e=!1}},[a,c?.id,y]),n.useEffect(()=>{if(!a)return;function e(t){if(t.key==="Escape"&&l?.(),t.key!=="Tab")return;const o=b.current?.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');if(!o||o.length===0)return;const u=o[0],w=o[o.length-1];t.shiftKey&&document.activeElement===u?(w.focus(),t.preventDefault()):!t.shiftKey&&document.activeElement===w&&(u.focus(),t.preventDefault())}return document.addEventListener("keydown",e),()=>document.removeEventListener("keydown",e)},[a,l]),!a)return null;const v=!!E?.id;async function R(){if(d(""),!!c?.id){h(!0);try{const e={product_id:c.id,user_id:k||void 0,floral:r(s.floral),fruity:r(s.fruity),citrus:r(s.citrus),woody:r(s.woody),fresh:r(s.fresh),spicy:r(s.spicy),sweet:r(s.sweet),smoky:r(s.smoky),strength:r(s.strength)};await z(e);try{j?.({floral:s.floral,fruity:s.fruity,citrus:s.citrus,woody:s.woody,fresh:s.fresh,spicy:s.spicy,sweet:s.sweet,smoky:s.smoky,strength:s.strength})}catch{}l?.()}catch(e){console.error(e),d(e?.message||"Something went wrong.")}finally{h(!1)}}}const C={position:"fixed",inset:0,zIndex:1e3,background:"rgba(0,0,0,.45)",backdropFilter:"blur(2px)",display:"flex",alignItems:"center",justifyContent:"center",padding:16},T={width:"min(720px, 92vw)",maxHeight:"90vh",overflow:"auto",borderRadius:16,border:"1px solid var(--hairline)",background:"linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)), #0f0c0f",boxShadow:"0 12px 32px rgba(0,0,0,.45)"},I={position:"sticky",top:0,zIndex:1,display:"flex",alignItems:"center",justifyContent:"space-between",gap:12,padding:14,background:"rgba(0,0,0,.35)",backdropFilter:"blur(2px)",borderBottom:"1px solid var(--hairline)"};return D.createPortal(i.jsx("div",{className:"modal-veil",style:C,onClick:e=>e.target===e.currentTarget&&l?.(),children:i.jsxs("div",{ref:b,className:"glass modal-card",style:T,children:[i.jsxs("div",{className:"glass-header",style:I,children:[i.jsxs("div",{style:{display:"grid"},children:[i.jsx("div",{className:"modalTitle",children:v?"Update your rating":"Rate this candle’s profile"}),i.jsx("small",{style:{opacity:.7},children:c?.title||"—"})]}),i.jsx("button",{className:"btn btn--icon",onClick:l,"aria-label":"Close",children:"✕"})]}),i.jsxs("div",{style:{padding:16,display:"grid",gap:14},children:[N&&i.jsx("div",{style:{opacity:.8},children:"Loading your previous rating…"}),i.jsx("div",{style:{display:"grid",gap:10},children:F.map((e,t)=>i.jsxs("div",{style:{display:"grid",gridTemplateColumns:"140px 1fr",alignItems:"center",gap:10},children:[i.jsx("label",{style:{textTransform:"capitalize",opacity:.9},children:e}),i.jsx("input",{ref:t===0?x:void 0,type:"range",min:"0",max:"5",value:s[e],onChange:o=>g(u=>({...u,[e]:Number(o.target.value)}))})]},e))}),p?i.jsx("div",{style:{color:"#ffb3b3"},children:p}):null,i.jsxs("div",{style:{display:"flex",gap:10,justifyContent:"flex-end"},children:[i.jsx("button",{className:"btn btn--ghost",onClick:l,disabled:f,children:"Cancel"}),i.jsx("button",{className:"btn btn--gold",onClick:R,disabled:f,children:f?"Sending…":v?"Update rating":"Submit rating"})]})]})]})}),document.body)}export{U as default};
