import{s as m}from"./index-Cfo4WONF.js";const f=e=>(e??0)/100,b=e=>String(e).toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"");function g(e){if(Array.isArray(e)||e===null||typeof e=="object")return e;if(typeof e=="string")try{return JSON.parse(e)}catch{}return null}function _(e){const n=g(e.variants)??[],r=g(e.options)??[],i=Array.isArray(n)?n:[],c=Array.isArray(r)?r:[],l=i.map(t=>t.price_cents).filter(t=>t!=null),s=l.length?l:[e.price_cents??0],o=Math.min(...s),d=Math.max(...s);return{id:e.id,title:e.title,handle:e.slug??e.handle??null,description:e.description||"",collection:e.collection||"",images:{nodes:e.image_url?[{url:e.image_url}]:[]},priceRange:{minVariantPrice:{amount:f(o),currencyCode:"USD"},maxVariantPrice:{amount:f(d),currencyCode:"USD"}},variants:{nodes:i.map(t=>{const a=Array.isArray(t.selectedOptions)&&t.selectedOptions.length?t.selectedOptions:[t.wax?{name:"Wax",value:String(t.wax)}:null,t.size?{name:"Size",value:String(t.size)}:null].filter(Boolean);return{id:t.id??t.sku??`${e.id}:${b(t.title||[t.wax,t.size].filter(Boolean).join(" / ")||"default")}`,title:t.title??(a.length?a.map(p=>p.value).join(" / "):"Default"),availableForSale:t.availableForSale!=null?!!t.availableForSale:!0,price:{amount:t.price_cents!=null?f(t.price_cents):null,currencyCode:"USD"},selectedOptions:a}})},options:c,collections:{nodes:e.collection?[{title:e.collection,handle:String(e.collection).toLowerCase()}]:[]},tags:Array.isArray(e.tags)?e.tags:[],image_url:e.image_url||null,price_cents:e.price_cents??null}}async function S(e,n=2e4,r="op"){let i;try{return await Promise.race([e,new Promise((l,s)=>i=setTimeout(()=>s(new Error(`[timeout] ${r} > ${n}ms`)),n))])}finally{clearTimeout(i)}}async function x(e){let{data:n,error:r}=await m.from("products").select("*").eq("slug",e).maybeSingle();if(r?.code==="42703"||!n&&!r){const i=await m.from("products").select("*").eq("handle",e).maybeSingle();n=i.data,r=i.error}if(r)throw r;return n?_(n):null}async function $({q:e,collection:n,tags:r,minPriceCents:i,maxPriceCents:c,order:l="new",page:s=1,pageSize:o=24}={}){const d=Math.max(0,(s-1)*o),t=d+o-1;let a=m.from("products").select("*",{count:"exact"});if(e&&e.trim()){const u=`%${e.trim()}%`;a=a.or(`title.ilike.${u},description.ilike.${u}`)}if(n&&n!=="all"){const A={affirmation:"Affirmation",afrodisia:"Afrodisia",pantheon:"Pantheon",fall:"Fall",winter:"Winter"}[n]??n;a=a.eq("collection",A)}r&&r.length&&(a=a.overlaps("tags",r.map(u=>u.toLowerCase()))),typeof i=="number"&&(a=a.gte("price_cents",i)),typeof c=="number"&&(a=a.lte("price_cents",c)),l==="price_asc"?a=a.order("price_cents",{ascending:!0,nullsLast:!0}):l==="price_desc"?a=a.order("price_cents",{ascending:!1,nullsLast:!0}):a=a.order("created_at",{ascending:!1,nullsLast:!0}),a=a.range(d,t);const{data:y,error:p,count:h}=await S(a,2e4,"products.search");if(p)throw p;return{rows:(y||[]).map(_),total:h||0,page:s,pageSize:o}}export{x as f,$ as s};
